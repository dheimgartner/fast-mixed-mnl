#!/bin/sh

# Find R compilers
CC=`${R_HOME}/bin/R CMD config CC`
CFLAGS=`${R_HOME}/bin/R CMD config CFLAGS`
# compiler and flags to 'cc' file
echo "CC=${CC}" > inst/cc
echo "CFLAGS=${CFLAGS}" >> inst/cc

# gcc compiler info to output #3291
case $CC in gcc*)
  GCCV=`${CC} -dumpfullversion -dumpversion`
  echo "$CC $GCCV"
esac

# Test if we have a OPENMP compatible compiler
# Aside: ${SHLIB_OPENMP_CFLAGS} does not appear to be defined at this point according to Matt's testing on
# Linux, and c also returns 'no information for variable'. That's not
# inconsistent with R-exts$1.2.1.1, though, which states it's 'available for use in Makevars' (so not
# necessarily here in configure). Hence use -fopenmp directly for this detection step.
# printf not echo to pass checkbashisms w.r.t. to the \n
printf "#include <omp.h>\nint main () { return omp_get_num_threads(); }" | ${CC} ${CFLAGS} -fopenmp -xc - >/dev/null 2>&1 || R_NO_OPENMP=1;
rm a.out >/dev/null 2>&1

# Write to Makevars
if [ $R_NO_OPENMP ]; then
  echo "*** OpenMP not supported! mixl uses OpenMP to enable parallelisation"
  echo "*** For details on how to install the necessary toolchains on your OS see:"
  echo "***   https://github.com/Rdatatable/data.table/wiki/Installation"
  echo "*** Continuing installation without OpenMP support..."
  sed -e "s|@openmp_cflags@||" src/Makevars.in > src/Makevars
  sed -e "s|@openmp_cflags@||" inst/include/MIXL_OPENMP_FLAG.in > inst/include/MIXL_OPENMP_FLAG
else
  echo "OpenMP supported"
  echo "setting flag for compliation by package to '\$(SHLIB_OPENMP_CFLAGS)'"
  sed -e "s|@openmp_cflags@|\$(SHLIB_OPENMP_CFLAGS)|" src/Makevars.in > src/Makevars
  sed -e "s|@openmp_cflags@|\$(SHLIB_OPENMP_CFLAGS)|" inst/include/MIXL_OPENMP_FLAG.in > inst/include/MIXL_OPENMP_FLAG
fi

exit 0